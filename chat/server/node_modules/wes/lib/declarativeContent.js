"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
Object.defineProperty(exports, "DeclarativeContentCompatibility", {
  enumerable: true,
  get: function get() {
    return _declarativeContent.default;
  }
});
exports.default = exports.DeclarativeContent = exports.PageStateMatcher = exports.ShowPageAction = exports.SetIcon = exports.RequestContentScript = void 0;

var _isNil = _interopRequireDefault(require("lodash/isNil"));

var _isPlainObject = _interopRequireDefault(require("lodash/isPlainObject"));

var _map = _interopRequireDefault(require("lodash/map"));

var _pick = _interopRequireDefault(require("lodash/pick"));

var _base = _interopRequireDefault(require("./core/base"));

var _declarativeContent = _interopRequireDefault(require("./declarativeContent.json"));

var _event = require("./core/event");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }

function _get(object, property, receiver) { if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { return _get(parent, property, receiver); } } else if ("value" in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

// region Actions
var Action = function Action() {
  _classCallCheck(this, Action);
};

var RequestContentScript =
/*#__PURE__*/
function (_Action) {
  _inherits(RequestContentScript, _Action);

  function RequestContentScript(options) {
    var _this;

    _classCallCheck(this, RequestContentScript);

    _this = _possibleConstructorReturn(this, (RequestContentScript.__proto__ || Object.getPrototypeOf(RequestContentScript)).call(this));
    _this._options = options;
    return _this;
  }

  _createClass(RequestContentScript, [{
    key: "$create",
    value: function $create(api) {
      return new (api.$property('RequestContentScript'))(this._options);
    }
  }]);

  return RequestContentScript;
}(Action);

exports.RequestContentScript = RequestContentScript;

var SetIcon =
/*#__PURE__*/
function (_Action2) {
  _inherits(SetIcon, _Action2);

  function SetIcon(options) {
    var _this2;

    _classCallCheck(this, SetIcon);

    _this2 = _possibleConstructorReturn(this, (SetIcon.__proto__ || Object.getPrototypeOf(SetIcon)).call(this));
    _this2._options = options;
    return _this2;
  }

  _createClass(SetIcon, [{
    key: "$create",
    value: function $create(api) {
      return new (api.$property('SetIcon'))(this._options);
    }
  }]);

  return SetIcon;
}(Action);

exports.SetIcon = SetIcon;

var ShowPageAction =
/*#__PURE__*/
function (_Action3) {
  _inherits(ShowPageAction, _Action3);

  function ShowPageAction() {
    _classCallCheck(this, ShowPageAction);

    return _possibleConstructorReturn(this, (ShowPageAction.__proto__ || Object.getPrototypeOf(ShowPageAction)).apply(this, arguments));
  }

  _createClass(ShowPageAction, [{
    key: "$create",
    value: function $create(api) {
      return new (api.$property('ShowPageAction'))();
    }
  }]);

  return ShowPageAction;
}(Action); // endregion
// region Conditions


exports.ShowPageAction = ShowPageAction;

var Condition = function Condition() {
  _classCallCheck(this, Condition);
};

var PageStateMatcher =
/*#__PURE__*/
function (_Condition) {
  _inherits(PageStateMatcher, _Condition);

  function PageStateMatcher(options) {
    var _this3;

    _classCallCheck(this, PageStateMatcher);

    _this3 = _possibleConstructorReturn(this, (PageStateMatcher.__proto__ || Object.getPrototypeOf(PageStateMatcher)).call(this));
    _this3._options = options;
    return _this3;
  }

  _createClass(PageStateMatcher, [{
    key: "$create",
    value: function $create(api) {
      return new (api.$property('PageStateMatcher'))(this._options);
    }
  }]);

  return PageStateMatcher;
}(Condition); // endregion


exports.PageStateMatcher = PageStateMatcher;

var DeclarativeContentEvent =
/*#__PURE__*/
function (_DeclarativeEvent) {
  _inherits(DeclarativeContentEvent, _DeclarativeEvent);

  function DeclarativeContentEvent() {
    _classCallCheck(this, DeclarativeContentEvent);

    return _possibleConstructorReturn(this, (DeclarativeContentEvent.__proto__ || Object.getPrototypeOf(DeclarativeContentEvent)).apply(this, arguments));
  }

  _createClass(DeclarativeContentEvent, [{
    key: "addRules",
    value: function addRules(rules) {
      var _this4 = this;

      return this._createRules(rules).then(function (rules) {
        return _get(DeclarativeContentEvent.prototype.__proto__ || Object.getPrototypeOf(DeclarativeContentEvent.prototype), "addRules", _this4).call(_this4, rules);
      });
    }
  }, {
    key: "_createRules",
    value: function _createRules(rules) {
      var _this5 = this;

      return Promise.resolve().then(function () {
        return (0, _map.default)(rules, function (rule) {
          if ((0, _isNil.default)(rule) || !(0, _isPlainObject.default)(rule)) {
            throw new Error("Invalid rule: ".concat(rule));
          }

          if ((0, _isNil.default)(rule.actions) || !Array.isArray(rule.actions)) {
            throw new Error("Invalid actions: ".concat(rule.actions));
          }

          if ((0, _isNil.default)(rule.conditions) || !Array.isArray(rule.conditions)) {
            throw new Error("Invalid conditions: ".concat(rule.conditions));
          }

          if (rule.actions.length < 1) {
            throw new Error('At least one action is required');
          }

          if (rule.conditions.length < 1) {
            throw new Error('At least one condition is required');
          }

          return _extends({}, (0, _pick.default)(rule, ['id', 'priority', 'tags']), {
            // Create actions
            actions: (0, _map.default)(rule.actions, function (action) {
              if (!(action instanceof Action)) {
                throw new Error("Invalid action: ".concat(action));
              }

              return action.$create(_this5._api);
            }),
            // Create conditions
            conditions: (0, _map.default)(rule.conditions, function (condition) {
              if (!(condition instanceof Condition)) {
                throw new Error("Invalid condition: ".concat(condition));
              }

              return condition.$create(_this5._api);
            })
          });
        });
      });
    }
  }]);

  return DeclarativeContentEvent;
}(_event.DeclarativeEvent);

var DeclarativeContent =
/*#__PURE__*/
function (_Base) {
  _inherits(DeclarativeContent, _Base);

  function DeclarativeContent() {
    var _this6;

    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;

    _classCallCheck(this, DeclarativeContent);

    _this6 = _possibleConstructorReturn(this, (DeclarativeContent.__proto__ || Object.getPrototypeOf(DeclarativeContent)).call(this, options)); // region Events

    _this6.onPageChanged = new DeclarativeContentEvent(_this6, 'onPageChanged'); // endregion

    return _this6;
  }

  return DeclarativeContent;
}(_base.default);

exports.DeclarativeContent = DeclarativeContent;
Object.defineProperty(DeclarativeContent, "Title", {
  configurable: true,
  enumerable: true,
  writable: true,
  value: 'DeclarativeContent'
});
Object.defineProperty(DeclarativeContent, "Name", {
  configurable: true,
  enumerable: true,
  writable: true,
  value: 'declarativeContent'
});
Object.defineProperty(DeclarativeContent, "Compatibility", {
  configurable: true,
  enumerable: true,
  writable: true,
  value: _declarativeContent.default
});

var _default = new DeclarativeContent();

exports.default = _default;